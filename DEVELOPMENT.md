# WakeyWakey Development Guide

Build and contribute to WakeyWakey.

## Clone the Repository

```bash
# HTTPS
git clone https://github.com/brndnsvr/WakeyWakey.git

# SSH
git clone git@github.com:brndnsvr/WakeyWakey.git

cd WakeyWakey
```

## Requirements

- macOS 15.0 or later
- Xcode with macOS 15 SDK
- Homebrew
- XcodeGen (`brew install xcodegen`)
- create-dmg (`brew install create-dmg`) — for releases only

## Project Structure

```
WakeyWakey/
├── WakeyWakey.xcodeproj        # Generated by XcodeGen (don't edit directly)
├── project.yml                 # XcodeGen configuration
├── README.md                   # User documentation
├── DEVELOPMENT.md              # This file
├── scripts/
│   ├── build_debug.sh          # Debug build (arm64)
│   ├── build_release.sh        # Release build (arm64)
│   ├── generate_appicon.sh     # Create AppIcon assets from source PNG
│   ├── generate_project.sh     # Run xcodegen generate
│   ├── install.sh              # Copy built app to /Applications
│   ├── kill.sh                 # Kill running app
│   ├── release.sh              # Create DMG and GitHub release
│   └── run.sh                  # Open app from /Applications
├── Icon_WakeyWakey.icon/
│   ├── Assets/image.png        # Source image for app icon
│   └── icon.json
└── WakeyWakey/
    ├── AppDelegate.swift       # App logic (menu bar, timers, jiggle)
    ├── main.swift              # Required entry point for menu bar app
    └── Resources/Info.plist    # LSUIElement=true (no Dock icon)
```

## Initial Setup

```bash
# Install dependencies
brew install xcodegen

# Set your Apple Developer Team ID (required for code signing)
export WAKEY_TEAM_ID="YOUR_TEAM_ID"
# Add to ~/.zshrc or ~/.bashrc to persist

# Generate Xcode project
./scripts/generate_project.sh

# (Optional) Regenerate app icon if you modify the source PNG
./scripts/generate_appicon.sh
```

## Build & Run (Debug)

```bash
./scripts/build_debug.sh
./scripts/install.sh
./scripts/run.sh
```

First launch will prompt for Accessibility permission. If the dialog doesn't appear:
1. System Settings → Privacy & Security → Accessibility
2. Add WakeyWakey and enable it
3. Relaunch the app

To stop the app:
```bash
./scripts/kill.sh
```

## Release Build

### Create DMG (local only)
```bash
./scripts/release.sh 1.0.0
```
Creates `dist/WakeyWakey-1.0.0.dmg` with drag-to-Applications installer.

### Create DMG + Publish to GitHub
```bash
./scripts/release.sh 1.0.0 --publish
```
This will:
1. Build the release
2. Create the DMG
3. Tag the release (`v1.0.0`)
4. Push the tag
5. Create a GitHub release with the DMG attached

### Manual Release Build
```bash
./scripts/build_release.sh
cp -R build/Build/Products/Release/WakeyWakey.app /Applications/
```

### Update Homebrew Tap

After publishing a new GitHub release, update the Homebrew cask:

1. Get the SHA256 of the new DMG:
   ```bash
   shasum -a 256 dist/WakeyWakey-X.Y.Z.dmg
   ```

2. Edit `~/code/homebrew-tap/Casks/wakeywakey.rb`:
   - Update `version "X.Y.Z"`
   - Update `sha256 "..."`
   - Update the URL if the filename pattern changed

3. Commit and push:
   ```bash
   cd ~/code/homebrew-tap
   git add -A && git commit -m "Update wakeywakey to vX.Y.Z" && git push
   ```

## Configuration

| Setting | Value | Location |
|---------|-------|----------|
| Bundle ID | `com.brndnsvr.WakeyWakey` | Info.plist, project.yml |
| Deployment Target | macOS 15.0 | project.yml |
| Architecture | arm64 only | project.yml, scripts |
| Code Signing | Automatic | project.yml |
| Team ID | `$WAKEY_TEAM_ID` env var | project.yml |

To find your Team ID: Open Xcode → Settings → Accounts → Select your team → View team ID.

After changing config, regenerate with `./scripts/generate_project.sh`.

## How It Works

### Behavior
- **Idle threshold**: 42 seconds — jiggles only start after this
- **Jiggle interval**: 42-79 seconds (random) between movements
- **Step size**: 11-23 pixels (random)
- **Center bias**: 52% of jiggles move toward screen center

### Architecture
1. `main.swift` → `NSApplication.shared` → `AppDelegate()` → `app.run()`
2. `AppDelegate.init()` sets `.accessory` policy (no Dock icon)
3. `applicationDidFinishLaunching`: status item, menu, accessibility check, 1Hz timer
4. `tick()` runs every second → idle detection → schedule/perform jiggles

### Key APIs
- **IOKit IOPM assertions** — prevent system idle sleep
- **ApplicationServices CGEvents** — post mouse movements
- **ServiceManagement SMAppService** — Launch at Login
- **AXIsProcessTrustedWithOptions** — auto-open Accessibility settings

### Idle Detection
```swift
let types: [CGEventType] = [.mouseMoved, .leftMouseDown, .keyDown, .keyUp, ...]
let idle = types.map { CGEventSource.secondsSinceLastEventType(.hidSystemState, $0) }.min()!
```
Takes minimum across explicit event types for robustness with DisplayLink/virtual displays.

### Multi-Monitor Coordinate Conversion
- Cocoa: origin at bottom-left of main display
- Quartz: origin at top-left of main display
- Movements are clamped to current screen bounds

## Troubleshooting (Development)

- **No menu bar icon** — Ensure `LSUIElement=true` in Info.plist and running from /Applications
- **Menu not responding** — Check `button.target` and `button.action` are set
- **Jiggle during typing** — Idle detection uses min across all event types
- **Cursor jumps to primary display** — Coordinates must be clamped to current screen

## Technical Notes

- Uses AppKit (not SwiftUI) with a required `main.swift` for proper menu bar init
- `NSApp.setActivationPolicy(.accessory)` must be in `init()`, NOT `applicationDidFinishLaunching`
- The deprecated `popUpMenu` method is used intentionally — it works reliably
- 52% center bias prevents cursor drift to screen edges over long sessions
